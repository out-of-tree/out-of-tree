name: Ubuntu

on: [push, pull_request]

jobs:
  build:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: go build

  test-unit:
    name: Unit Testing
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Install dependencies for tests
      run: |
        sudo apt-get update
        sudo apt-get install qemu-system-x86

    - name: Bootstrap
      run: ./tools/qemu-ubuntu-img/bootstrap.sh

    - name: Unit Testing
      run: go test -parallel 1 -v ./...

  test-end-to-end:
    name: End-to-End Testing
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: go build

    - name: Install dependencies for tests
      run: |
        sudo apt-get update
        sudo apt-get install qemu-system-x86

    - name: End-to-End Testing [Kernel Module]
      run: |
        cd examples/kernel-module
        ../../out-of-tree --log-level=debug kernel autogen --max=1
        ../../out-of-tree --log-level=debug pew --qemu-timeout=10m

    - name: End-to-End Testing [Kernel Exploit]
      run: |
        cd examples/kernel-exploit
        ../../out-of-tree --log-level=debug kernel autogen --max=1
        ../../out-of-tree --log-level=debug pew --threshold=0 --qemu-timeout=10m

    - name: Archive logs
      uses: actions/upload-artifact@v3
      with:
        name: test-end-to-end-logs
        path: /home/runner/.out-of-tree/logs/out-of-tree.log

  test-end-to-end-kernels:
    name: End-to-End Testing (kernels)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: go build

    - name: Install dependencies for tests
      run: |
        sudo apt-get update
        sudo apt-get install qemu-system-x86

    - name: End-to-End Testing [Install one Ubuntu 18.04 kernel]
      run: |
        ./out-of-tree --log-level=debug kernel install --distro=Ubuntu --ver=18.04 --kernel=4.15.0-70-generic

    - name: End-to-End Testing [Reinstall one Ubuntu 18.04 kernel]
      run: |
        ./out-of-tree --log-level=debug kernel install --distro=Ubuntu --ver=18.04 --kernel=4.15.0-70-generic --force

    - name: End-to-End Testing [Install one Ubuntu 22.04 kernel w/o headers]
      run: |
        ./out-of-tree --log-level=debug kernel install --distro=Ubuntu --ver=22.04 --kernel=5.19.0-28-generic --no-headers

    - name: End-to-End Testing [Install one CentOS 7 kernel]
      run: |
        ./out-of-tree --log-level=debug kernel install --distro=CentOS --ver=7 --kernel=3.10.0-862.6.3 --no-download

    - name: End-to-End Testing [Install one CentOS 7 kernel w/o headers]
      run: |
        ./out-of-tree --log-level=debug kernel install --distro=CentOS --ver=7 --kernel=3.10.0-1160.71.1 --no-download --no-headers

    - name: End-to-End Testing [Install one CentOS 8 kernel]
      run: |
        ./out-of-tree --log-level=debug kernel install --distro=CentOS --ver=8 --kernel=4.18.0-348.7.1 --no-download

    - name: Archive logs
      uses: actions/upload-artifact@v3
      with:
        name: test-end-to-end-kernels-log
        path: /home/runner/.out-of-tree/logs/out-of-tree.log

  test-end-to-end-genall:
    name: End-to-End Testing (genall)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: go build

    - name: Install dependencies for tests
      run: |
        sudo apt-get update
        sudo apt-get install qemu-system-x86

    - name: End-to-End Testing [Install all Ubuntu 22.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel genall --distro=Ubuntu --ver=22.04

    - name: Archive logs
      uses: actions/upload-artifact@v3
      with:
        name: test-end-to-end-genall-logs
        path: /home/runner/.out-of-tree/logs/out-of-tree.log

  test-end-to-end-list-remote:
    name: End-to-End Testing (list-remote)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: go build

    - name: Install dependencies for tests
      run: |
        sudo apt-get update
        sudo apt-get install qemu-system-x86

    - name: End-to-End Testing [List available Ubuntu 12.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=Ubuntu --ver=12.04

    - name: End-to-End Testing [List available Ubuntu 14.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=Ubuntu --ver=14.04

    - name: End-to-End Testing [List available Ubuntu 16.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=Ubuntu --ver=16.04

    - name: End-to-End Testing [List available Ubuntu 18.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=Ubuntu --ver=18.04

    - name: End-to-End Testing [List available Ubuntu 20.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=Ubuntu --ver=20.04

    - name: End-to-End Testing [List available Ubuntu 22.04 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=Ubuntu --ver=22.04

    - name: End-to-End Testing [List available CentOS 6 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=CentOS --ver=6

    - name: End-to-End Testing [List available CentOS 7 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=CentOS --ver=7

    - name: End-to-End Testing [List available CentOS 8 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=CentOS --ver=8

    - name: End-to-End Testing [List available Oracle Linux 6 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=OracleLinux --ver=6

    - name: End-to-End Testing [List available Oracle Linux 7 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=OracleLinux --ver=7

    - name: End-to-End Testing [List available Oracle Linux 8 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=OracleLinux --ver=8

    - name: End-to-End Testing [List available Oracle Linux 9 kernels]
      run: |
        ./out-of-tree --log-level=debug kernel list-remote --distro=OracleLinux --ver=9

    - name: Archive logs
      uses: actions/upload-artifact@v3
      with:
        name: test-end-to-end-list-remote-logs
        path: /home/runner/.out-of-tree/logs/out-of-tree.log

  test-end-to-end-ubuntu:
    name: End-to-End Testing (Ubuntu)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        release: [12.04, 14.04, 16.04, 18.04, 20.04, 22.04]

    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: go build

    - name: Install dependencies for tests
      run: |
        sudo apt-get update
        sudo apt-get install qemu-system-x86

    - name: End-to-End Testing [Ubuntu ${{ matrix.release }}]
      run: |
        mkdir test
        cd test

        echo 'name = "out-of-tree script"' >> .out-of-tree.toml
        echo 'type = "script"' >> .out-of-tree.toml
        echo 'script = "script.sh"' >> .out-of-tree.toml
        echo '[[supported_kernels]]' >> .out-of-tree.toml
        echo 'distro_type = "Ubuntu"' >> .out-of-tree.toml
        echo 'distro_release = "${{ matrix.release }}"' >> .out-of-tree.toml
        echo 'release_mask = ".*"' >> .out-of-tree.toml

        echo -e '#!/bin/sh\necho ok' >> script.sh

        ../out-of-tree --log-level=debug kernel autogen --max=1 --shuffle
        ../out-of-tree --log-level=debug pew --qemu-timeout=10m

    - name: Archive logs
      uses: actions/upload-artifact@v3
      with:
        name: test-end-to-end-ubuntu
        path: /home/runner/.out-of-tree/logs/out-of-tree.log
